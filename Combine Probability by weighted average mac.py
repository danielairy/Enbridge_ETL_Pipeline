# -*- coding: utf-8 -*-
"""
Created on Mon Dec 12 13:26:20 2016

@author: chod1
"""

import pandas as pd
import os 
import numpy as np
import math
import collections
CWD =r"/Users/Danielcho/Google Drive/Data Merge"
os.chdir(CWD)
#action = pd.read_excel(r".\action.xlsx",index_col= 0, squeeze=True)
def weighed_average(grp):
    return grp._get_numeric_data().multiply(grp['Length (m) - PiMSlider'], axis=0).sum()/grp['Length (m) - PiMSlider'].sum()
    #return  np.average(grp, axis=0, weights=grp['Length (m) - PiMSlider'])
bigmerged=[]
actiondict = {
        'id - PiMSlider':  lambda x: 'id ' + str(np.min(x)) +'-' + str( np.max(x)), 
        'Segment - IRAS':  lambda x:x.value_counts().index[0] if x.notnull().all() else None,    
        'Segment - PiMSlider':lambda x: 'segment ' +  str(np.min(x)) +'-' + str( np.max(x)),
        'idSegment - PiMSlider': lambda x:x.value_counts().index[0] if x.notnull().all() else None,
        'Pipeline Index - PiMSlider' : lambda x:x.value_counts().index[0] if x.notnull().all() else None,
        'Pipeline Name - PiMSlider' : lambda x:x.value_counts().index[0] if x.notnull().all() else None,
        'Segment ID - PiMSlider' : lambda x:x.value_counts().index[0] if x.notnull().all() else None,
        'Start Chainage (m) - PiMSlider':np.min ,
        'End Chainage (m) - PiMSlider':np.max ,
        'Length (m) - PiMSlider':'sum',
        'HCA Name - PiMSlider':lambda x:x.value_counts().index[0] if x.notnull().all() else None,
        'HCA Start Chainage (m) - PiMSlider':np.min ,
        'HCA End Chainage (m) - PiMSlider':np.max,
        'Rupture Ignition - Health & Safety - PiMSlider':'sum',
        'Rupture Ignition - Physical Damage & Econ Loss - PiMSlider':'sum',
        'Rupture Ignition - Evironmental Damage - PiMSlider':'sum',
        'Rupture Ignition - Regulatory Impact - PiMSlider':'sum',
        'Rupture Ignition - Customer Satisfaction - PiMSlider':'sum',
        'Rupture Ignition - Corporate Image - PiMSlider':'sum',
        'Rupture No Ignition - Health & Safety - PiMSlider':'sum',
        'Rupture No Ignition - Physical Damage & Econ Loss - PiMSlider':'sum',
        'Rupture No Ignition - Evironmental Damage - PiMSlider':'sum',
        'Rupture No Ignition - Regulatory Impact - PiMSlider':'sum',
        'Rupture No Ignition - Customer Satisfaction - PiMSlider':'sum',
        'Rupture No Ignition - Corporate Image - PiMSlider':'sum',
        'Leak Pinhole No Ignition - Health & Safety - PiMSlider':'sum',
        'Leak Pinhole No Ignition - Physical Damage & Econ Loss - PiMSlider':'sum',
        'Leak Pinhole No Ignition - Evironmental Damage - PiMSlider':'sum',
        'Leak Pinhole No Ignition - Regulatory Impact - PiMSlider':'sum',
        'Leak Pinhole No Ignition - Customer Satisfaction - PiMSlider':'sum',
        'Leak Pinhole No Ignition - Corporate Image - PiMSlider':'sum',
        'Leak 10mm Ignition - Health & Safety - PiMSlider':'sum',
        'Leak 10mm Ignition - Physical Damage & Econ Loss - PiMSlider':'sum',
        'Leak 10mm Ignition - Evironmental Damage - PiMSlider':'sum',
        'Leak 10mm Ignition - Regulatory Impact - PiMSlider':'sum',
        'Leak 10mm Ignition - Customer Satisfaction - PiMSlider':'sum',
        'Leak 10mm Ignition - Corporate Image - PiMSlider':'sum',
        'Leak 10mm No Ignition - Health & Safety - PiMSlider':'sum',
        'Leak 10mm No Ignition - Physical Damage & Econ Loss - PiMSlider':'sum',
        'Leak 10mm No Ignition - Evironmental Damage - PiMSlider':'sum',
        'Leak 10mm No Ignition - Regulatory Impact - PiMSlider':'sum',
        'Leak 10mm No Ignition - Customer Satisfaction - PiMSlider':'sum',
        'Leak 10mm No Ignition - Corporate Image - PiMSlider':'sum',
        'Leak  2580mm Ignited - Health & Safety - PiMSlider':'sum',
        'Leak  2580mm Ignited - Physical Damage & Econ Loss - PiMSlider':'sum',
        'Leak  2580mm Ignited - Evironmental Damage - PiMSlider':'sum',
        'Leak  2580mm Ignited - Regulatory Impact - PiMSlider':'sum',
        'Leak  2580mm Ignited - Customer Satisfaction - PiMSlider':'sum',
        'Leak  2580mm Ignited - Corporate Image - PiMSlider':'sum',
        'Leak  2580mm No Ignition - Health & Safety - PiMSlider':'sum',
        'Leak  2580mm No Ignition - Physical Damage & Econ Loss - PiMSlider':'sum',
        'Leak  2580mm No Ignition - Evironmental Damage - PiMSlider':'sum',
        'Leak  2580mm No Ignition - Regulatory Impact - PiMSlider':'sum',
        'Leak  2580mm No Ignition - Customer Satisfaction - PiMSlider':'sum',
        'Leak  2580mm No Ignition - Corporate Image - PiMSlider':'sum',
        'Total Consequence ($) - PiMSlider':'sum',
        'Risk/m ($/m.yr) - PiMSlider':lambda x: x.sum() * 1000 ,
        'Total Risk ($/yr) - PiMSlider':'sum',
        'Risk ($/m.yr) - Health & Safety - PiMSlider':lambda x: x.sum() * 1000,
        'Risk ($/m.yr) - Physical Damage & Econ Loss - PiMSlider':lambda x: x.sum() * 1000,
        'Risk ($/m.yr) - Evironmental Damage - PiMSlider':lambda x: x.sum() * 1000,
        'Risk ($/m.yr) - Regulatory Impact - PiMSlider':lambda x: x.sum() * 1000,
        'Risk ($/m.yr) - Customer Satisfaction - PiMSlider':lambda x: x.sum() * 1000,
        'Risk ($/m.yr) - Corporate Image - PiMSlider':lambda x: x.sum() * 1000,
        'nmStartMeter - PiMSlider':np.min ,
        'nmEndMeter - PiMSlider':np.max}

def f(grp):
    return pd.DataFrame({'Stress Corrosion Cracking (SCC) (/m.yr)':np.sum(grp['Stress Corrosion Cracking (SCC) (/m.yr)']),
        'Manufacturing-Related Defects (/m.yr)':np.sum(grp['Manufacturing-Related Defects (/m.yr)']),
        'Welding / Fabrication Related Defects (/m.yr)':np.sum(grp['Welding / Fabrication Related Defects (/m.yr)'])})

def read_file():
    PIM_filepath = r"PiMSlider Risk_Dec13 - Duplicates removed.xls"
    #PIM_filepath = r".\test1.xls"
    #IRIS_filepath = r".\EGDI Stress Corrosion Cracking Run 2548 by Segment - oshawa.xls"
    IRIS_filepath =r"Combined with idSegments - Unique headers.xlsx"
    IRIS = pd.read_excel(IRIS_filepath, skip_rows=3, header=3) # read the file and only the third row
    #
    PIM = pd.read_excel ( PIM_filepath,sheetname=0)
    #IRIS["index combined"] = IRIS["Index"].str.cat(IRIS["Index.1"])
    PIM = PIM.apply(lambda x: x.astype('float32') if x.dtypes == np.dtype('float64') else x)
    IRIS = IRIS.apply(lambda x: x.astype('float32') if x.dtypes == np.dtype('float64') else x)
    return PIM, IRIS

def cond_merge(PIM,IRIS):
    df = IRIS.merge(PIM,left_on="idSegment - IRAS",right_on="idSegment - PiMSlider",how='left', suffixes=(' - IRAS',' - PiMSlider')) 
    within_IRIS_bucket =  df['Start Chainage (m) - PiMSlider'].between(df['Start Chainage (m) - IRAS'],df['End Chainage (m) - IRAS'] ) & df['End Chainage (m) - PiMSlider'].between(df['Start Chainage (m) - IRAS'],df['End Chainage (m) - IRAS'] )  
    PIM_start_sticking_out =  df['Start Chainage (m) - IRAS'].between(df['Start Chainage (m) - PiMSlider'], df['End Chainage (m) - PiMSlider']   )
    PIM_end_sticking_out =  df['End Chainage (m) - IRAS'].between(df['Start Chainage (m) - PiMSlider'],  df['End Chainage (m) - PiMSlider'] )
    groupsIwant = within_IRIS_bucket | PIM_start_sticking_out | PIM_end_sticking_out 
    df = df [ groupsIwant ]
    within_IRIS_bucket =  df['Start Chainage (m) - PiMSlider'].between(df['Start Chainage (m) - IRAS'],df['End Chainage (m) - IRAS'] ) & df['End Chainage (m) - PiMSlider'].between(df['Start Chainage (m) - IRAS'],df['End Chainage (m) - IRAS'] )  
    PIM_start_sticking_out =  df['Start Chainage (m) - IRAS'].between(df['Start Chainage (m) - PiMSlider'], df['End Chainage (m) - PiMSlider']   )
    PIM_end_sticking_out =  df['End Chainage (m) - IRAS'].between(df['Start Chainage (m) - PiMSlider'],  df['End Chainage (m) - PiMSlider'] )
    df.loc[PIM_start_sticking_out,'Start Chainage (m) - PiMSlider'] = df.loc[PIM_start_sticking_out,'Start Chainage (m) - IRAS']
    df.loc[PIM_start_sticking_out,'Length (m) - PiMSlider'] = df.loc[PIM_start_sticking_out,'End Chainage (m) - PiMSlider'] - df.loc[PIM_start_sticking_out,'Start Chainage (m) - PiMSlider']
    # Cutting the line by adjusting PIM End to match IRIS End for End sticking out and recalculate length
    df.loc[PIM_end_sticking_out,'End Chainage (m) - PiMSlider'] = df.loc[PIM_end_sticking_out,'End Chainage (m) - IRAS']
    df.loc[PIM_end_sticking_out,'Length (m) - PiMSlider'] = df.loc[PIM_end_sticking_out,'End Chainage (m) - PiMSlider'] - df.loc[PIM_end_sticking_out,'Start Chainage (m) - PiMSlider']
    return df
    
def cond_merge2(PIM,IRIS):
    columns_for_cond_merge_IRIS = ['Segment - IRAS','idSegment - IRAS','Start Chainage (m) - IRAS','End Chainage (m) - IRAS' ]
    columns_for_cond_merge_PIM = ['Start Chainage (m) - PiMSlider','End Chainage (m) - PiMSlider','Length (m) - PiMSlider','Segment - PiMSlider','idSegment - PiMSlider']
    df = IRIS[columns_for_cond_merge_IRIS].merge(PIM[columns_for_cond_merge_PIM],left_on="idSegment - IRAS",right_on="idSegment - PiMSlider",how='left', suffixes=(' - IRAS',' - PiMSlider')) 
    within_IRIS_bucket =  df['Start Chainage (m) - PiMSlider'].between(df['Start Chainage (m) - IRAS'],df['End Chainage (m) - IRAS'] ) & df['End Chainage (m) - PiMSlider'].between(df['Start Chainage (m) - IRAS'],df['End Chainage (m) - IRAS'] )  
    PIM_start_sticking_out =  df['Start Chainage (m) - IRAS'].between(df['Start Chainage (m) - PiMSlider'], df['End Chainage (m) - PiMSlider']   )
    PIM_end_sticking_out =  df['End Chainage (m) - IRAS'].between(df['Start Chainage (m) - PiMSlider'],  df['End Chainage (m) - PiMSlider'] )
    groupsIwant = within_IRIS_bucket | PIM_start_sticking_out | PIM_end_sticking_out 
    df = df [ groupsIwant ]
    within_IRIS_bucket =  df['Start Chainage (m) - PiMSlider'].between(df['Start Chainage (m) - IRAS'],df['End Chainage (m) - IRAS'] ) & df['End Chainage (m) - PiMSlider'].between(df['Start Chainage (m) - IRAS'],df['End Chainage (m) - IRAS'] )  
    PIM_start_sticking_out =  df['Start Chainage (m) - IRAS'].between(df['Start Chainage (m) - PiMSlider'], df['End Chainage (m) - PiMSlider']   )
    PIM_end_sticking_out =  df['End Chainage (m) - IRAS'].between(df['Start Chainage (m) - PiMSlider'],  df['End Chainage (m) - PiMSlider'] )
    df.loc[PIM_start_sticking_out,'Start Chainage (m) - PiMSlider'] = df.loc[PIM_start_sticking_out,'Start Chainage (m) - IRAS']
    df.loc[PIM_start_sticking_out,'Length (m) - PiMSlider'] = df.loc[PIM_start_sticking_out,'End Chainage (m) - PiMSlider'] - df.loc[PIM_start_sticking_out,'Start Chainage (m) - PiMSlider']
    # Cutting the line by adjusting PIM End to match IRIS End for End sticking out and recalculate length
    df.loc[PIM_end_sticking_out,'End Chainage (m) - PiMSlider'] = df.loc[PIM_end_sticking_out,'End Chainage (m) - IRAS']
    df.loc[PIM_end_sticking_out,'Length (m) - PiMSlider'] = df.loc[PIM_end_sticking_out,'End Chainage (m) - PiMSlider'] - df.loc[PIM_end_sticking_out,'Start Chainage (m) - PiMSlider']
    
    rest_of_the_columns_PIM = [i for i in PIM.columns if i not in columns_for_cond_merge_PIM] + ['Segment - PiMSlider'] 
    rest_of_the_columns_IRIS = [i for i in IRIS.columns if i not in columns_for_cond_merge_IRIS] +['Segment - IRAS']
    df = df.merge(IRIS[rest_of_the_columns_IRIS], how='left' ,on = 'Segment - IRAS')
    df = df.merge(PIM[rest_of_the_columns_PIM],how='left', on = 'Segment - PiMSlider')
    return df
    
def merge_file(PIM,IRIS):
    df = cond_merge2(PIM,IRIS)
    
    column_to_wavg = ['Segment - IRAS','Length (m) - PiMSlider','External Corrosion (/m.yr) - Rupture, Ignition - PiMSlider','External Corrosion (/m.yr) - Rupture, No Ignition - PiMSlider','External Corrosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','External Corrosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Corrosion (/m.yr) - Rupture, Ignition - PiMSlider','Internal Corrosion (/m.yr) - Rupture, No Ignition - PiMSlider','Internal Corrosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','Internal Corrosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Erosion (/m.yr) - Rupture, Ignition - PiMSlider','Internal Erosion (/m.yr) - Rupture, No Ignition - PiMSlider','Internal Erosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','Internal Erosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Rupture, Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Rupture, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Rupture, Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Rupture, No Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Rupture, Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Rupture, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Equipment Failure (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Weather-Related (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Rupture, Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Rupture, No Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Leak , 2580mm, No Ignition - PiMSlider','Outside Forces (/m.yr) - Rupture, Ignition - PiMSlider','Outside Forces (/m.yr) - Rupture, No Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Rupture, Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Rupture, No Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Incorrect Operation Procedures (/m.yr) - Leak , 2580mm, No Ignition - PiMSlider','External Corrosion (/m.yr) - PiMSlider','Internal Corrosion (/m.yr) - PiMSlider','Internal Erosion (/m.yr) - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - PiMSlider','Manufacturing-Related Defects (/m.yr) - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - PiMSlider','Equipment Failure (/m.yr) - PiMSlider','Weather-Related (/m.yr) - PiMSlider','Third Party / Mechanical Damage (/m.yr) - PiMSlider','Outside Forces (/m.yr) - PiMSlider','Incorrect Operation Procedures (/m.yr) - PiMSlider','Rupture, Ignition (/m.yr) - PiMSlider','Rupture, No Ignition (/m.yr) - PiMSlider','Leak, Pinhole, No Ignition (/m.yr) - PiMSlider','Leak, 10mm, Ignited (/m.yr) - PiMSlider','Leak, 10mm, No Ignition (/m.yr) - PiMSlider','Leak , 2580mm, Ignited (/m.yr) - PiMSlider','Leak , 2580mm, No Ignition (/m.yr) - PiMSlider','Total Probability (/m.yr) - PiMSlider']
    columns_to_agg = ['id - PiMSlider','Segment - IRAS','Segment - PiMSlider','idSegment - PiMSlider','Pipeline Index - PiMSlider','Pipeline Name - PiMSlider','Segment ID - PiMSlider','Start Chainage (m) - PiMSlider','End Chainage (m) - PiMSlider','Length (m) - PiMSlider','HCA Name - PiMSlider','HCA Start Chainage (m) - PiMSlider','HCA End Chainage (m) - PiMSlider','Rupture Ignition - Health & Safety - PiMSlider','Rupture Ignition - Physical Damage & Econ Loss - PiMSlider','Rupture Ignition - Evironmental Damage - PiMSlider','Rupture Ignition - Regulatory Impact - PiMSlider','Rupture Ignition - Customer Satisfaction - PiMSlider','Rupture Ignition - Corporate Image - PiMSlider','Rupture No Ignition - Health & Safety - PiMSlider','Rupture No Ignition - Physical Damage & Econ Loss - PiMSlider','Rupture No Ignition - Evironmental Damage - PiMSlider','Rupture No Ignition - Regulatory Impact - PiMSlider','Rupture No Ignition - Customer Satisfaction - PiMSlider','Rupture No Ignition - Corporate Image - PiMSlider','Leak Pinhole No Ignition - Health & Safety - PiMSlider','Leak Pinhole No Ignition - Physical Damage & Econ Loss - PiMSlider','Leak Pinhole No Ignition - Evironmental Damage - PiMSlider','Leak Pinhole No Ignition - Regulatory Impact - PiMSlider','Leak Pinhole No Ignition - Customer Satisfaction - PiMSlider','Leak Pinhole No Ignition - Corporate Image - PiMSlider','Leak 10mm Ignition - Health & Safety - PiMSlider','Leak 10mm Ignition - Physical Damage & Econ Loss - PiMSlider','Leak 10mm Ignition - Evironmental Damage - PiMSlider','Leak 10mm Ignition - Regulatory Impact - PiMSlider','Leak 10mm Ignition - Customer Satisfaction - PiMSlider','Leak 10mm Ignition - Corporate Image - PiMSlider','Leak 10mm No Ignition - Health & Safety - PiMSlider','Leak 10mm No Ignition - Physical Damage & Econ Loss - PiMSlider','Leak 10mm No Ignition - Evironmental Damage - PiMSlider','Leak 10mm No Ignition - Regulatory Impact - PiMSlider','Leak 10mm No Ignition - Customer Satisfaction - PiMSlider','Leak 10mm No Ignition - Corporate Image - PiMSlider','Leak  2580mm Ignited - Health & Safety - PiMSlider','Leak  2580mm Ignited - Physical Damage & Econ Loss - PiMSlider','Leak  2580mm Ignited - Evironmental Damage - PiMSlider','Leak  2580mm Ignited - Regulatory Impact - PiMSlider','Leak  2580mm Ignited - Customer Satisfaction - PiMSlider','Leak  2580mm Ignited - Corporate Image - PiMSlider','Leak  2580mm No Ignition - Health & Safety - PiMSlider','Leak  2580mm No Ignition - Physical Damage & Econ Loss - PiMSlider','Leak  2580mm No Ignition - Evironmental Damage - PiMSlider','Leak  2580mm No Ignition - Regulatory Impact - PiMSlider','Leak  2580mm No Ignition - Customer Satisfaction - PiMSlider','Leak  2580mm No Ignition - Corporate Image - PiMSlider','Total Consequence ($) - PiMSlider','Risk/m ($/m.yr) - PiMSlider','Total Risk ($/yr) - PiMSlider','Risk ($/m.yr) - Health & Safety - PiMSlider','Risk ($/m.yr) - Physical Damage & Econ Loss - PiMSlider','Risk ($/m.yr) - Evironmental Damage - PiMSlider','Risk ($/m.yr) - Regulatory Impact - PiMSlider','Risk ($/m.yr) - Customer Satisfaction - PiMSlider','Risk ($/m.yr) - Corporate Image - PiMSlider','nmStartMeter - PiMSlider','nmEndMeter - PiMSlider']
    columns_to_convert_per_m_to_per_km = ['External Corrosion (/m.yr) - Rupture, Ignition - PiMSlider','External Corrosion (/m.yr) - Rupture, No Ignition - PiMSlider','External Corrosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','External Corrosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Corrosion (/m.yr) - Rupture, Ignition - PiMSlider','Internal Corrosion (/m.yr) - Rupture, No Ignition - PiMSlider','Internal Corrosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','Internal Corrosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Erosion (/m.yr) - Rupture, Ignition - PiMSlider','Internal Erosion (/m.yr) - Rupture, No Ignition - PiMSlider','Internal Erosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','Internal Erosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Rupture, Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Rupture, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Rupture, Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Rupture, No Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Rupture, Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Rupture, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Equipment Failure (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Weather-Related (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Rupture, Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Rupture, No Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Leak , 2580mm, No Ignition - PiMSlider','Outside Forces (/m.yr) - Rupture, Ignition - PiMSlider','Outside Forces (/m.yr) - Rupture, No Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Rupture, Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Rupture, No Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Incorrect Operation Procedures (/m.yr) - Leak , 2580mm, No Ignition - PiMSlider','External Corrosion (/m.yr) - PiMSlider','Internal Corrosion (/m.yr) - PiMSlider','Internal Erosion (/m.yr) - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - PiMSlider','Manufacturing-Related Defects (/m.yr) - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - PiMSlider','Equipment Failure (/m.yr) - PiMSlider','Weather-Related (/m.yr) - PiMSlider','Third Party / Mechanical Damage (/m.yr) - PiMSlider','Outside Forces (/m.yr) - PiMSlider','Incorrect Operation Procedures (/m.yr) - PiMSlider','Rupture, Ignition (/m.yr) - PiMSlider','Rupture, No Ignition (/m.yr) - PiMSlider','Leak, Pinhole, No Ignition (/m.yr) - PiMSlider','Leak, 10mm, Ignited (/m.yr) - PiMSlider','Leak, 10mm, No Ignition (/m.yr) - PiMSlider','Leak , 2580mm, Ignited (/m.yr) - PiMSlider','Leak , 2580mm, No Ignition (/m.yr) - PiMSlider','Total Probability (/m.yr) - PiMSlider']
    columns_to_rename_per_m_to_per_km = ['Risk/m ($/m.yr) - PiMSlider','Total Risk ($/yr) - PiMSlider','Risk ($/m.yr) - Health & Safety - PiMSlider','Risk ($/m.yr) - Physical Damage & Econ Loss - PiMSlider','Risk ($/m.yr) - Evironmental Damage - PiMSlider','Risk ($/m.yr) - Regulatory Impact - PiMSlider','Risk ($/m.yr) - Customer Satisfaction - PiMSlider','Risk ($/m.yr) - Corporate Image - PiMSlider'] + ['External Corrosion (/m.yr) - Rupture, Ignition - PiMSlider','External Corrosion (/m.yr) - Rupture, No Ignition - PiMSlider','External Corrosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','External Corrosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Corrosion (/m.yr) - Rupture, Ignition - PiMSlider','Internal Corrosion (/m.yr) - Rupture, No Ignition - PiMSlider','Internal Corrosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','Internal Corrosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Erosion (/m.yr) - Rupture, Ignition - PiMSlider','Internal Erosion (/m.yr) - Rupture, No Ignition - PiMSlider','Internal Erosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','Internal Erosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Rupture, Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Rupture, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Rupture, Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Rupture, No Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Rupture, Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Rupture, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Equipment Failure (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Weather-Related (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Rupture, Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Rupture, No Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Leak , 2580mm, No Ignition - PiMSlider','Outside Forces (/m.yr) - Rupture, Ignition - PiMSlider','Outside Forces (/m.yr) - Rupture, No Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Rupture, Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Rupture, No Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Incorrect Operation Procedures (/m.yr) - Leak , 2580mm, No Ignition - PiMSlider','External Corrosion (/m.yr) - PiMSlider','Internal Corrosion (/m.yr) - PiMSlider','Internal Erosion (/m.yr) - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - PiMSlider','Manufacturing-Related Defects (/m.yr) - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - PiMSlider','Equipment Failure (/m.yr) - PiMSlider','Weather-Related (/m.yr) - PiMSlider','Third Party / Mechanical Damage (/m.yr) - PiMSlider','Outside Forces (/m.yr) - PiMSlider','Incorrect Operation Procedures (/m.yr) - PiMSlider','Rupture, Ignition (/m.yr) - PiMSlider','Rupture, No Ignition (/m.yr) - PiMSlider','Leak, Pinhole, No Ignition (/m.yr) - PiMSlider','Leak, 10mm, Ignited (/m.yr) - PiMSlider','Leak, 10mm, No Ignition (/m.yr) - PiMSlider','Leak , 2580mm, Ignited (/m.yr) - PiMSlider','Leak , 2580mm, No Ignition (/m.yr) - PiMSlider','Total Probability (/m.yr) - PiMSlider']
  
    
    wa = df[column_to_wavg].groupby('Segment - IRAS').apply(weighed_average)
    wa[columns_to_convert_per_m_to_per_km] = wa[columns_to_convert_per_m_to_per_km] *1000
    agg = df[columns_to_agg].groupby('Segment - IRAS').agg(actiondict)
    
    #df.groupby('Segment_IRIS').apply(f)
    #df.groupby('Segment_IRIS').apply(lambda x: np.average(x['Equipment Failure (/m.yr)'], weights=x['Length (m) - PiMSlider']))
    def cleanup_before_merge(wa):
        wa = wa.drop(['Segment - IRAS','Length (m) - PiMSlider'],1)
        wa = wa.reset_index(drop=False)
        return wa
    wa = cleanup_before_merge(wa)
    #agg = agg.reset_index(drop=True)
    #IRIS = IRIS.set_index('Segment')
    #mergedx = pd.concat([IRIS,agg,wa])
    PIM_calculated = pd.merge(agg,wa,on='Segment - IRAS', how='left', suffixes=('_agg','_wa'))
    merged = pd.merge(IRIS,PIM_calculated,on='Segment - IRAS',how='left', suffixes=(' - IRAS',' - PiMSlider'))
    merged.rename(columns=lambda x: x.replace('/m.yr','/km.yr'),inplace=True)
    #merged = merged.drop('Segment_IRIS')
    #df.groupby('Segment_IRIS').agg(OrderedDict([("Manufacturing-Related Defects (/m.yr) - Leak, Pinhole, No Ignition",np.mean), ("Leak  2580mm No Ignition - Regulatory Impact",weighed_average  )]     ))
    #IRIS.groupby('Segment_IRIS').apply(lambda x: np.average(IRIS['Probability of Ignition, Rupture'], weights=IRIS['Length (m) - PiMSlider'] )).unique()
    
    return merged
def export_file(merged):
    exportcolumns =['idSegment - IRAS','Pipeline Index - PiMSlider','Pipeline Name - PiMSlider','Start Chainage (m) - IRAS','End Chainage (m) - IRAS','Start Chainage (m) - PiMSlider','End Chainage (m) - PiMSlider','Segment - IRAS','id - PiMSlider','Length (m) - IRAS','Length (m) - PiMSlider','Regulator - Equipment Failure - IRAS','Valve Presence - Equipment Failure - IRAS','Flange, Regulator, Meter Presence - Equipment Failure - IRAS','Equipment Questionnaire Score (/92) - Equipment Failure - IRAS','Equipment Presence Factor - Equipment Failure - IRAS','Equipment Adjustment Factor - Equipment Failure - IRAS','EF Probability of Leak (/km.yr) - Equipment Failure - IRAS','Probability of Ignition, Rupture - Equipment Failure - IRAS','EF Leak (pinhole) - No Ignition (/km.yr) - Equipment Failure - IRAS','Equipment Failure (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Equipment Failure (/km.yr) - Equipment Failure - IRAS','Consequence ($) - Equipment Failure - IRAS','Total Consequence ($) - Equipment Failure - IRAS','Equipment Failure (/m.yr) - PiMSlider','Regulator - External Corrosion - IRAS','Outside Diameter (mm) - External Corrosion - IRAS','Wall Thickness (mm) - External Corrosion - IRAS','MOP (kPa ) - External Corrosion - IRAS','Pipe MAOP (kPa ) - External Corrosion - IRAS','Pipe Grade (MPa) - External Corrosion - IRAS','Installation Year - External Corrosion - IRAS','Directionally Drilled - External Corrosion - IRAS','ILI Date - External Corrosion - IRAS','ILI Segment Length (m) - External Corrosion - IRAS','External ILI Feature - External Corrosion - IRAS','Industry Feature Density (/km) - External Corrosion - IRAS','EC Feature Incidence Density, no ILI (/km) - External Corrosion - IRAS','Probability of Rupture Method A - External Corrosion - IRAS','Probability of Rupture Method B - External Corrosion - IRAS','Rupture Failure Frequency, Method B Norm (/km.yr) - External Corrosion - IRAS','EC Rupture Failure Frequency (/km.yr) - External Corrosion - IRAS','Probability of Leak Method A - External Corrosion - IRAS','Probability of Leak Method B - External Corrosion - IRAS','Leak Failure Frequency, Method B Norm (/km.yr) - External Corrosion - IRAS','EC Leak Failure Frequency (/km.yr) - External Corrosion - IRAS','Probability of Ignition, Rupture - External Corrosion - IRAS','EC Rupture - Ignited (/km.yr) - External Corrosion - IRAS','EC Rupture - Not Ignited (/km.yr) - External Corrosion - IRAS','EC Leak (10mm2) - Ignited (/km.yr) - External Corrosion - IRAS','EC Leak (10mm2) - Not Ignited (/km.yr) - External Corrosion - IRAS','GeoTech Adjustment Factor - External Corrosion - IRAS','External Corrosion (/km.yr) - External Corrosion - IRAS','Consequence ($) - External Corrosion - IRAS','Total Consequence ($) - External Corrosion - IRAS','External Corrosion (/m.yr) - Rupture, Ignition - PiMSlider','External Corrosion (/m.yr) - Rupture, No Ignition - PiMSlider','External Corrosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','External Corrosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','External Corrosion (/m.yr) - PiMSlider','Regulator - Incorrect Operation Procedures - IRAS','IO Questionnaire Score (/69) - Incorrect Operation Procedures - IRAS','IO Adjustment Factor - Incorrect Operation Procedures - IRAS','IO Rupture Failure  Frequency (/km.yr) - Incorrect Operation Procedures - IRAS','IO Leak Failure Frequency (/km.yr) - Incorrect Operation Procedures - IRAS','Probability of Ignition, Rupture - Incorrect Operation Procedures - IRAS','IO Rupture - Ignited (/km.yr) - Incorrect Operation Procedures - IRAS','IO Rupture - Not Ignited (/km.yr) - Incorrect Operation Procedures - IRAS','IO Leak (2580mm) - Ignited (/km.yr) - Incorrect Operation Procedures - IRAS','I Leak (2580mm) - Not Ignited (/km.yr) - Incorrect Operation Procedures - IRAS','Incorrect Operation Procedures (/km.yr) - Incorrect Operation Procedures - IRAS','Consequence ($) - Incorrect Operation Procedures - IRAS','Total Consequence ($) - Incorrect Operation Procedures - IRAS','Incorrect Operation Procedures (/m.yr) - Rupture, Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Rupture, No Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Incorrect Operation Procedures (/m.yr) - Leak , 2580mm, No Ignition - PiMSlider','Incorrect Operation Procedures (/m.yr) - PiMSlider','Regulator - Internal Corrosion - IRAS','Outside Diameter (mm) - Internal Corrosion - IRAS','Wall Thickness (mm) - Internal Corrosion - IRAS','MOP (kPa ) - Internal Corrosion - IRAS','Pipe MAOP (kPa ) - Internal Corrosion - IRAS','Pipe Grade (MPa) - Internal Corrosion - IRAS','Installation Year - Internal Corrosion - IRAS','ILI Date - Internal Corrosion - IRAS','ILI Segment Length (m) - Internal Corrosion - IRAS','Internal ILI Feature - Internal Corrosion - IRAS','Industry Feature Density (/km) - Internal Corrosion - IRAS','IC Feature Incidence Density, no ILI (/km) - Internal Corrosion - IRAS','IC Rupture Probability Method A - Internal Corrosion - IRAS','IC Rupture Probability Method B - Internal Corrosion - IRAS','Rupture Failure Frequency, Method B Norm (/km.yr) - Internal Corrosion - IRAS','IC Rupture Failure Frequency (/km.yr) - Internal Corrosion - IRAS','IC Leak Probability, Method A - Internal Corrosion - IRAS','IC Leak Probability, Method B - Internal Corrosion - IRAS','Leak Failure Frequency, Method B Norm (/km.yr) - Internal Corrosion - IRAS','IC Leak Failure Frequency (/km.yr) - Internal Corrosion - IRAS','Probability of Ignition, Rupture - Internal Corrosion - IRAS','IC Rupture - Ignited (/km.yr) - Internal Corrosion - IRAS','IC Rupture - Not Ignited (/km.yr) - Internal Corrosion - IRAS','IC Leak (10mm) - Ignited (/km.yr) - Internal Corrosion - IRAS','IC Leak (10mm) - Not Ignited (/km.yr) - Internal Corrosion - IRAS','Internal Corrosion (/km.yr) - Internal Corrosion - IRAS','Consequence ($) - Internal Corrosion - IRAS','Total Consequence ($) - Internal Corrosion - IRAS','Internal Corrosion (/m.yr) - Rupture, Ignition - PiMSlider','Internal Corrosion (/m.yr) - Rupture, No Ignition - PiMSlider','Internal Corrosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','Internal Corrosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Corrosion (/m.yr) - PiMSlider','Regulator - Internal Erosion - IRAS','Outside Diameter (mm) - Internal Erosion - IRAS','Wall Thickness (mm) - Internal Erosion - IRAS','MOP (kPa ) - Internal Erosion - IRAS','Installation Year - Internal Erosion - IRAS','Peak Flow (m^3/d) - Internal Erosion - IRAS','Compressability - Internal Erosion - IRAS','Peak Product Velocity (m/s) - Internal Erosion - IRAS','Erosion Score - Internal Erosion - IRAS','Erosion Adjustment Factor - Internal Erosion - IRAS','Probability of Ignition, Rupture - Internal Erosion - IRAS','Erosion Rupture - Ignited (/km.yr) - Internal Erosion - IRAS','Erosion Rupture - Not Ignited (/km.yr) - Internal Erosion - IRAS','Erosion Leak (10mm) - Ignited (/km.yr) - Internal Erosion - IRAS','Erosion Leak (10mm) - Not Ignited (/km.yr) - Internal Erosion - IRAS','Internal Erosion (/km.yr) - Internal Erosion - IRAS','Consequence ($) - Internal Erosion - IRAS','Total Consequence ($) - Internal Erosion - IRAS','Internal Erosion (/m.yr) - Rupture, Ignition - PiMSlider','Internal Erosion (/m.yr) - Rupture, No Ignition - PiMSlider','Internal Erosion (/m.yr) - Leak, 10mm, Ignition - PiMSlider','Internal Erosion (/m.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Erosion (/m.yr) - PiMSlider','Regulator - Manufacturing Related Defects - IRAS','Outside Diameter (mm) - Manufacturing Related Defects - IRAS','Wall Thickness (mm) - Manufacturing Related Defects - IRAS','Pipe Grade (MPa) - Manufacturing Related Defects - IRAS','MOP (kPa ) - Manufacturing Related Defects - IRAS','Installation Year - Manufacturing Related Defects - IRAS','% SMYS - Manufacturing Related Defects - IRAS','MD Probability of Rupture (/km.yr) - Manufacturing Related Defects - IRAS','MD Probability of Leak (/km.yr) - Manufacturing Related Defects - IRAS','Probability of Ignition, Rupture - Manufacturing Related Defects - IRAS','MD Rupture - Ignited (/km.yr) - Manufacturing Related Defects - IRAS','MD Rupture - Not Ignited (/km.yr) - Manufacturing Related Defects - IRAS','MD Leak (pinhole) - Not Ignited (/km.yr) - Manufacturing Related Defects - IRAS','Manufacturing-Related Defects (/km.yr) - Manufacturing Related Defects - IRAS','Consequence ($) - Manufacturing Related Defects - IRAS','Total Consequence ($) - Manufacturing Related Defects - IRAS','Manufacturing-Related Defects (/m.yr) - Rupture, Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Rupture, No Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Manufacturing-Related Defects (/m.yr) - PiMSlider','Regulator - Outside Forces - IRAS','Geotechnical Segment Length (m) - Outside Forces - IRAS','Ground Movement Rate - Outside Forces - IRAS','Ground Movement Rate Factor - Outside Forces - IRAS','Weld Quality - Outside Forces - IRAS','Weld Quality Factor - Outside Forces - IRAS','Large-scale Pipe Strain - Outside Forces - IRAS','Large-scale Pipe Strain Factor - Outside Forces - IRAS','GeoTech Adjustment Factor - Outside Forces - IRAS','Geotechnical Failure Rupture Frequency (/km.yr) - Outside Forces - IRAS','Probability of Ignition, Rupture - Outside Forces - IRAS','Geotechnical Rupture - Ignited (/km.yr) - Outside Forces - IRAS','Geotechnical Rupture - Not-Ignited - Outside Forces - IRAS','Outside Forces (/km.yr) - Outside Forces - IRAS','Consequence ($) - Outside Forces - IRAS','Total Consequence ($) - Outside Forces - IRAS','Outside Forces (/m.yr) - Rupture, Ignition - PiMSlider','Outside Forces (/m.yr) - Rupture, No Ignition - PiMSlider','Outside Forces (/m.yr) - PiMSlider','Regulator - Stress Corrosion Cracking (SCC) - IRAS','Wall Thickness (mm) - Stress Corrosion Cracking (SCC) - IRAS','Outside Diameter (mm) - Stress Corrosion Cracking (SCC) - IRAS','MOP (kPa ) - Stress Corrosion Cracking (SCC) - IRAS','Pipe Grade (MPa) - Stress Corrosion Cracking (SCC) - IRAS','% SMYS - Stress Corrosion Cracking (SCC) - IRAS','SCC RF Factor A - Stress Corrosion Cracking (SCC) - IRAS','SCC RF Factor B - Stress Corrosion Cracking (SCC) - IRAS','SCC RF Factor C - Stress Corrosion Cracking (SCC) - IRAS','SCC  Rupture Frequency - Stress Corrosion Cracking (SCC) - IRAS','Line Coating - Stress Corrosion Cracking (SCC) - IRAS','SCC FR Factor A - Stress Corrosion Cracking (SCC) - IRAS','SCC FR Factor B - Stress Corrosion Cracking (SCC) - IRAS','SCC Failure Rate - Stress Corrosion Cracking (SCC) - IRAS','SCC Failure Rupture Frequency (/km.yr) - Stress Corrosion Cracking (SCC) - IRAS','SCC Failure  Leak Frequency (/km.yr) - Stress Corrosion Cracking (SCC) - IRAS','Probability of Ignition, Rupture - Stress Corrosion Cracking (SCC) - IRAS','SCC Rupture - Ignition (/km.yr) - Stress Corrosion Cracking (SCC) - IRAS','SCC Rupture -  No Ignition - Stress Corrosion Cracking (SCC) - IRAS','SCC Leak (pinhole) -  No Ignition (/km.yr) - Stress Corrosion Cracking (SCC) - IRAS','Stress Corrosion Cracking (SCC) (/km.yr) - Stress Corrosion Cracking (SCC) - IRAS','Consequence ($) - Stress Corrosion Cracking (SCC) - IRAS','Total Consequence ($) - Stress Corrosion Cracking (SCC) - IRAS','Stress Corrosion Cracking (SCC) (/m.yr) - Rupture, Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Rupture, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/m.yr) - PiMSlider','Regulator - Third Party / Mechanical Damage - IRAS','Outside Diameter (mm) - Third Party / Mechanical Damage - IRAS','MOP (kPa ) - Third Party / Mechanical Damage - IRAS','Wall Thickness (mm) - Third Party / Mechanical Damage - IRAS','Pipe Grade (MPa) - Third Party / Mechanical Damage - IRAS','Toughness (J) - Third Party / Mechanical Damage - IRAS','Utility Corridor (Y/N) - Third Party / Mechanical Damage - IRAS','Enbridge Property (Y/N) - Third Party / Mechanical Damage - IRAS','Class Area - Third Party / Mechanical Damage - IRAS','Land Use - Third Party / Mechanical Damage - IRAS','B1 - Pipe Location (/km.yr) - Third Party / Mechanical Damage - IRAS','B2 - Public Awareness - Third Party / Mechanical Damage - IRAS','B3 - Signage - Third Party / Mechanical Damage - IRAS','B4 - Markers - Third Party / Mechanical Damage - IRAS','B5 - 3rd Party Notification - Third Party / Mechanical Damage - IRAS','B7 - Patrol Frequency - Third Party / Mechanical Damage - IRAS','B9 - Response Time - Third Party / Mechanical Damage - IRAS','B10 - Pipe Finding - Third Party / Mechanical Damage - IRAS','B11 - Pipe Marking - Third Party / Mechanical Damage - IRAS','Depth of Cover (m) - Third Party / Mechanical Damage - IRAS','3rd Party Damage Impact Frequency (/km.yr) - Third Party / Mechanical Damage - IRAS','Geographic Environment - Third Party / Mechanical Damage - IRAS','Failure Due to Puncture - Third Party / Mechanical Damage - IRAS','Failure Probability Given a Hit - Third Party / Mechanical Damage - IRAS','Failure Due to Gouge in Dent - Third Party / Mechanical Damage - IRAS','Probability of Rupture (/km.yr) - Third Party / Mechanical Damage - IRAS','Probability of Leak (/km.yr) - Third Party / Mechanical Damage - IRAS','Probability of Ignition, Rupture - Third Party / Mechanical Damage - IRAS','3PD Rupture -  Ignition (/km.yr) - Third Party / Mechanical Damage - IRAS','3rd Party Damage Scaling Factor - Third Party / Mechanical Damage - IRAS','3PD Rupture - No Ignition (/km.yr) - Third Party / Mechanical Damage - IRAS','3PD Leak (2580mm2) - Ignition - Third Party / Mechanical Damage - IRAS','3PD Leak (2580mm2) - No Ignition (/km.yr) - Third Party / Mechanical Damage - IRAS','Third Party / Mechanical Damage (/km.yr) - Third Party / Mechanical Damage - IRAS','Consequence ($) - Third Party / Mechanical Damage - IRAS','Total Consequence ($) - Third Party / Mechanical Damage - IRAS','Third Party / Mechanical Damage (/m.yr) - Rupture, Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Rupture, No Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Third Party / Mechanical Damage (/m.yr) - Leak , 2580mm, No Ignition - PiMSlider','Third Party / Mechanical Damage (/m.yr) - PiMSlider','Regulator - Weater Related - IRAS','Environmental  Probability of Leak (/km.yr) - Weater Related - IRAS','Probability of Ignition, Rupture - Weater Related - IRAS','Environmental Leak (2580mm2) - Ignition (/km.yr) - Weater Related - IRAS','Weather-Related (/km.yr) - Weater Related - IRAS','Consequence ($) - Weater Related - IRAS','Total Consequence ($) - Weater Related - IRAS','Weather-Related (/m.yr) - Leak , 2580mm, Ignited - PiMSlider','Weather-Related (/m.yr) - PiMSlider','Regulator - Welding / Fabrication Related Defects - IRAS','Outside Diameter (mm) - Welding / Fabrication Related Defects - IRAS','Wall Thickness (mm) - Welding / Fabrication Related Defects - IRAS','MOP (kPa ) - Welding / Fabrication Related Defects - IRAS','Pipe Grade (MPa) - Welding / Fabrication Related Defects - IRAS','Installation Year - Welding / Fabrication Related Defects - IRAS','% SMYS - Welding / Fabrication Related Defects - IRAS','Probability of Ignition, Rupture - Welding / Fabrication Related Defects - IRAS','WFD Probability of Leak (/km.yr) - Welding / Fabrication Related Defects - IRAS','WFD Leak (pinhole) - No Ignition (/km.yr) - Welding / Fabrication Related Defects - IRAS','Welding / Fabrication Related Defects (/km.yr) - Welding / Fabrication Related Defects - IRAS','Consequence ($) - Welding / Fabrication Related Defects - IRAS','Total Consequence ($) - Welding / Fabrication Related Defects - IRAS','Welding / Fabrication Related Defects (/m.yr) - Rupture, Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Rupture, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - Leak, Pinhole, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/m.yr) - PiMSlider','Rupture, Ignition (/m.yr) - PiMSlider','Rupture, No Ignition (/m.yr) - PiMSlider','Leak, Pinhole, No Ignition (/m.yr) - PiMSlider','Leak, 10mm, Ignited (/m.yr) - PiMSlider','Leak, 10mm, No Ignition (/m.yr) - PiMSlider','Leak , 2580mm, Ignited (/m.yr) - PiMSlider','Leak , 2580mm, No Ignition (/m.yr) - PiMSlider','Total Probability (/m.yr) - PiMSlider','Rupture Ignition - Health & Safety - PiMSlider','Rupture Ignition - Physical Damage & Econ Loss - PiMSlider','Rupture Ignition - Evironmental Damage - PiMSlider','Rupture Ignition - Regulatory Impact - PiMSlider','Rupture Ignition - Customer Satisfaction - PiMSlider','Rupture Ignition - Corporate Image - PiMSlider','Rupture No Ignition - Health & Safety - PiMSlider','Rupture No Ignition - Physical Damage & Econ Loss - PiMSlider','Rupture No Ignition - Evironmental Damage - PiMSlider','Rupture No Ignition - Regulatory Impact - PiMSlider','Rupture No Ignition - Customer Satisfaction - PiMSlider','Rupture No Ignition - Corporate Image - PiMSlider','Leak Pinhole No Ignition - Health & Safety - PiMSlider','Leak Pinhole No Ignition - Physical Damage & Econ Loss - PiMSlider','Leak Pinhole No Ignition - Evironmental Damage - PiMSlider','Leak Pinhole No Ignition - Regulatory Impact - PiMSlider','Leak Pinhole No Ignition - Customer Satisfaction - PiMSlider','Leak Pinhole No Ignition - Corporate Image - PiMSlider','Leak 10mm Ignition - Health & Safety - PiMSlider','Leak 10mm Ignition - Physical Damage & Econ Loss - PiMSlider','Leak 10mm Ignition - Evironmental Damage - PiMSlider','Leak 10mm Ignition - Regulatory Impact - PiMSlider','Leak 10mm Ignition - Customer Satisfaction - PiMSlider','Leak 10mm Ignition - Corporate Image - PiMSlider','Leak 10mm No Ignition - Health & Safety - PiMSlider','Leak 10mm No Ignition - Physical Damage & Econ Loss - PiMSlider','Leak 10mm No Ignition - Evironmental Damage - PiMSlider','Leak 10mm No Ignition - Regulatory Impact - PiMSlider','Leak 10mm No Ignition - Customer Satisfaction - PiMSlider','Leak 10mm No Ignition - Corporate Image - PiMSlider','Leak  2580mm Ignited - Health & Safety - PiMSlider','Leak  2580mm Ignited - Physical Damage & Econ Loss - PiMSlider','Leak  2580mm Ignited - Evironmental Damage - PiMSlider','Leak  2580mm Ignited - Regulatory Impact - PiMSlider','Leak  2580mm Ignited - Customer Satisfaction - PiMSlider','Leak  2580mm Ignited - Corporate Image - PiMSlider','Leak  2580mm No Ignition - Health & Safety - PiMSlider','Leak  2580mm No Ignition - Physical Damage & Econ Loss - PiMSlider','Leak  2580mm No Ignition - Evironmental Damage - PiMSlider','Leak  2580mm No Ignition - Regulatory Impact - PiMSlider','Leak  2580mm No Ignition - Customer Satisfaction - PiMSlider','Leak  2580mm No Ignition - Corporate Image - PiMSlider','Total Consequence ($) - PiMSlider','Risk/m ($/m.yr) - PiMSlider','Total Risk ($/yr) - PiMSlider','Risk ($/m.yr) - Health & Safety - PiMSlider','Risk ($/m.yr) - Physical Damage & Econ Loss - PiMSlider','Risk ($/m.yr) - Evironmental Damage - PiMSlider','Risk ($/m.yr) - Regulatory Impact - PiMSlider','Risk ($/m.yr) - Customer Satisfaction - PiMSlider','Risk ($/m.yr) - Corporate Image - PiMSlider','nmStartMeter - PiMSlider','nmEndMeter - PiMSlider','Matrix - IRAS','Corporation - IRAS','Company 1 - IRAS','Company 2 - IRAS','Facility Type - IRAS','Index 1 - IRAS','Index 2 - IRAS','Begin Series - IRAS','Start Station (m) - IRAS','End Station (m) - IRAS','HCA Name - IRAS','HCA Start Section - IRAS','HCA Start Chainage (m) - IRAS','HCA End Section - IRAS','HCA End Chainage (m) - IRAS','HCA Start Station - IRAS','HCA Start Engg. Station (m) - IRAS','HCA End Series - IRAS','HCA End Engg. Station (m) - IRAS','Segment - PiMSlider','Segment ID - PiMSlider','HCA Name - PiMSlider','HCA Start Chainage (m) - PiMSlider','HCA End Chainage (m) - PiMSlider',]

    merged[exportcolumns].to_csv(r"{0}.csv".format(merged['Pipeline Name - PiMSlider'][0]), index = False, encoding = 'cp1252')
    #PIM.to_excel(r".\PIM.xlsx")
    
    
    
    
    #merged[exportcolumns].to_csv(r".\merged.csv",mode='w',  index = False, encoding = 'cp1252')

    return
def export_file_to_excel(merged):
    writer = pd.ExcelWriter(r"{0}.xlsx".format(merged['Pipeline Name - PiMSlider'][0]))
    to_show_every_sheet = ['idSegment - IRAS','idSegment - PiMSlider','Pipeline Index - PiMSlider','Pipeline Name - PiMSlider','Start Chainage (m) - IRAS','End Chainage (m) - IRAS','Start Chainage (m) - PiMSlider','End Chainage (m) - PiMSlider','Segment - IRAS','id - PiMSlider','Length (m) - IRAS','Length (m) - PiMSlider'] 
    Threat7 = ['EF Leak (pinhole) - No Ignition (/km.yr) - Equipment Failure - IRAS','Equipment Failure (/km.yr) - Leak, Pinhole, No Ignition - PiMSlider','Equipment Failure (/km.yr) - Equipment Failure - IRAS','Equipment Failure (/km.yr) - PiMSlider']
    Threat1 = ['EC Rupture - Ignited (/km.yr) - External Corrosion - IRAS','External Corrosion (/km.yr) - Rupture, Ignition - PiMSlider','EC Rupture - Not Ignited (/km.yr) - External Corrosion - IRAS','External Corrosion (/km.yr) - Rupture, No Ignition - PiMSlider','EC Leak (10mm2) - Ignited (/km.yr) - External Corrosion - IRAS','External Corrosion (/km.yr) - Leak, 10mm, Ignition - PiMSlider','EC Leak (10mm2) - Not Ignited (/km.yr) - External Corrosion - IRAS','External Corrosion (/km.yr) - Leak, 10mm, No Ignition - PiMSlider','External Corrosion (/km.yr) - External Corrosion - IRAS','External Corrosion (/km.yr) - PiMSlider']
    Threat11 = ['IO Rupture - Ignited (/km.yr) - Incorrect Operation Procedures - IRAS','Incorrect Operation Procedures (/km.yr) - Rupture, Ignition - PiMSlider','IO Rupture - Not Ignited (/km.yr) - Incorrect Operation Procedures - IRAS','Incorrect Operation Procedures (/km.yr) - Rupture, No Ignition - PiMSlider','IO Leak (2580mm) - Ignited (/km.yr) - Incorrect Operation Procedures - IRAS','Incorrect Operation Procedures (/km.yr) - Leak , 2580mm, Ignited - PiMSlider','I Leak (2580mm) - Not Ignited (/km.yr) - Incorrect Operation Procedures - IRAS','Incorrect Operation Procedures (/km.yr) - Leak , 2580mm, No Ignition - PiMSlider','Incorrect Operation Procedures (/km.yr) - Incorrect Operation Procedures - IRAS','Incorrect Operation Procedures (/km.yr) - PiMSlider']
    Threat2 = ['IC Rupture - Ignited (/km.yr) - Internal Corrosion - IRAS','Internal Corrosion (/km.yr) - Rupture, Ignition - PiMSlider','IC Rupture - Not Ignited (/km.yr) - Internal Corrosion - IRAS','Internal Corrosion (/km.yr) - Rupture, No Ignition - PiMSlider','IC Leak (10mm) - Ignited (/km.yr) - Internal Corrosion - IRAS','Internal Corrosion (/km.yr) - Leak, 10mm, Ignition - PiMSlider','IC Leak (10mm) - Not Ignited (/km.yr) - Internal Corrosion - IRAS','Internal Corrosion (/km.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Corrosion (/km.yr) - Internal Corrosion - IRAS','Internal Corrosion (/km.yr) - PiMSlider']
    Threat3 = ['Erosion Rupture - Ignited (/km.yr) - Internal Erosion - IRAS','Internal Erosion (/km.yr) - Rupture, Ignition - PiMSlider','Erosion Rupture - Not Ignited (/km.yr) - Internal Erosion - IRAS','Internal Erosion (/km.yr) - Rupture, No Ignition - PiMSlider','Erosion Leak (10mm) - Ignited (/km.yr) - Internal Erosion - IRAS','Internal Erosion (/km.yr) - Leak, 10mm, Ignition - PiMSlider','Erosion Leak (10mm) - Not Ignited (/km.yr) - Internal Erosion - IRAS','Internal Erosion (/km.yr) - Leak, 10mm, No Ignition - PiMSlider','Internal Erosion (/km.yr) - Internal Erosion - IRAS','Internal Erosion (/km.yr) - PiMSlider']
    Threat5 = ['MD Rupture - Ignited (/km.yr) - Manufacturing Related Defects - IRAS','Manufacturing-Related Defects (/km.yr) - Rupture, Ignition - PiMSlider','MD Rupture - Not Ignited (/km.yr) - Manufacturing Related Defects - IRAS','Manufacturing-Related Defects (/km.yr) - Rupture, No Ignition - PiMSlider','MD Leak (pinhole) - Not Ignited (/km.yr) - Manufacturing Related Defects - IRAS','Manufacturing-Related Defects (/km.yr) - Leak, Pinhole, No Ignition - PiMSlider','Manufacturing-Related Defects (/km.yr) - Manufacturing Related Defects - IRAS','Manufacturing-Related Defects (/km.yr) - PiMSlider']
    Threat10 = ['Geotechnical Rupture - Ignited (/km.yr) - Outside Forces - IRAS','Outside Forces (/km.yr) - Rupture, Ignition - PiMSlider','Geotechnical Rupture - Not-Ignited - Outside Forces - IRAS','Outside Forces (/km.yr) - Rupture, No Ignition - PiMSlider','Outside Forces (/km.yr) - Outside Forces - IRAS','Outside Forces (/km.yr) - PiMSlider']
    Threat4 = ['SCC Rupture - Ignition (/km.yr) - Stress Corrosion Cracking (SCC) - IRAS','Stress Corrosion Cracking (SCC) (/km.yr) - Rupture, Ignition - PiMSlider','SCC Rupture -  No Ignition - Stress Corrosion Cracking (SCC) - IRAS','Stress Corrosion Cracking (SCC) (/km.yr) - Rupture, No Ignition - PiMSlider','SCC Leak (pinhole) -  No Ignition (/km.yr) - Stress Corrosion Cracking (SCC) - IRAS','Stress Corrosion Cracking (SCC) (/km.yr) - Leak, Pinhole, No Ignition - PiMSlider','Stress Corrosion Cracking (SCC) (/km.yr) - Stress Corrosion Cracking (SCC) - IRAS','Stress Corrosion Cracking (SCC) (/km.yr) - PiMSlider']
    Threat9 = ['3PD Rupture -  Ignition (/km.yr) - Third Party / Mechanical Damage - IRAS','Third Party / Mechanical Damage (/km.yr) - Rupture, Ignition - PiMSlider','3PD Rupture - No Ignition (/km.yr) - Third Party / Mechanical Damage - IRAS','Third Party / Mechanical Damage (/km.yr) - Rupture, No Ignition - PiMSlider','3PD Leak (2580mm2) - Ignition - Third Party / Mechanical Damage - IRAS','Third Party / Mechanical Damage (/km.yr) - Leak , 2580mm, Ignited - PiMSlider','3PD Leak (2580mm2) - No Ignition (/km.yr) - Third Party / Mechanical Damage - IRAS','Third Party / Mechanical Damage (/km.yr) - Leak , 2580mm, No Ignition - PiMSlider','Third Party / Mechanical Damage (/km.yr) - Third Party / Mechanical Damage - IRAS','Third Party / Mechanical Damage (/km.yr) - PiMSlider']
    Threat8 = ['Environmental Leak (2580mm2) - Ignition (/km.yr) - Weater Related - IRAS','Weather-Related (/km.yr) - Leak , 2580mm, Ignited - PiMSlider','Weather-Related (/km.yr) - Weater Related - IRAS','Weather-Related (/km.yr) - PiMSlider']
    Threat6 = ['WFD Leak (pinhole) - No Ignition (/km.yr) - Welding / Fabrication Related Defects - IRAS','Welding / Fabrication Related Defects (/km.yr) - Leak, Pinhole, No Ignition - PiMSlider','Welding / Fabrication Related Defects (/km.yr) - Welding / Fabrication Related Defects - IRAS','Welding / Fabrication Related Defects (/km.yr) - PiMSlider']
      
    merged[to_show_every_sheet + Threat1].to_excel(writer,'01.External Corrosion')
    merged[to_show_every_sheet + Threat2].to_excel(writer,'02.Internal Corrosion')
    merged[to_show_every_sheet + Threat3].to_excel(writer,'03.Internal Erosion')
    merged[to_show_every_sheet + Threat4].to_excel(writer,'04.Stress Corrosion Cracking')
    merged[to_show_every_sheet + Threat5].to_excel(writer,'05.Manufacturing Defects')
    merged[to_show_every_sheet + Threat6].to_excel(writer,'06.Fabrication Defects')
    merged[to_show_every_sheet + Threat7].to_excel(writer,'07.Equipment Failure')
    merged[to_show_every_sheet + Threat8].to_excel(writer,'08.Weather')
    merged[to_show_every_sheet + Threat9].to_excel(writer,'09.Third Party Damage')
    merged[to_show_every_sheet + Threat10].to_excel(writer,'10.Outside Forces')
    merged[to_show_every_sheet + Threat11].to_excel(writer,'11.Incorrect Operation')
    writer.save()
    return
def main(bigmerged):
    
    PIM, IRIS =  read_file()
    groupedPIM = PIM.groupby('idSegment - PiMSlider')
    groupedIRIS = IRIS.groupby('idSegment - IRAS')
    #IRIS.merge(PIM,on="idSegment",how='left', suffixes=(' - IRAS',' - PiMSlider')) 
    #merged = merge_file(groupedPIM.get_group(27),groupedIRIS.get_group(27))
    #merged = merge_file(groupedPIM.get_group(27),groupedIRIS.get_group(27))
    #df = groupedIRIS.get_group(1).merge(groupedPIM.get_group(27),on="idSegment",how='left', suffixes=(' - IRAS',' - PiMSlider'))
    for name, group in groupedPIM:
        if name != 56:
            print(name)
            merged = merge_file(groupedPIM.get_group(name),groupedIRIS.get_group(name))
            export_file_to_excel(merged)
            #bigmerged = bigmerged.append(merged)
    return 
    
def testing_new_cond_merge():
    df = cond_merge2(groupedPIM.get_group(1),groupedIRIS.get_group(1))
    
    df = cond_merge2_1(df)
    df.to_csv(r"test.csv",index = False, encoding = 'cp1252')

def testing_merge_file():
    def testing_unit_conversion():
        df = cond_merge2(groupedPIM.get_group(27),groupedIRIS.get_group(27))
        Manufacturing = [i for i in wa.columns if 'Manufacturing' in i]
        agg.groupby('Segment - IRAS').agg({'Risk ($/m.yr) - Corporate Image - PiMSlider':lambda x: x.sum() })
        
        
        return
    return
    
def testing_unit_conversion_and_export_to_excel():
    merged = merge_file(groupedPIM.get_group(1),groupedIRIS.get_group(1))
    export_file_to_excel(merged)
    [i for i in merged.columns if '/m.yr' in i]
    return
    
def showing_group_size(groupedPIM,groupedIRIS):
    for name, group in groupedPIM:
        if name != 56:
            #merged = merge_file(groupedPIM.get_group(2),groupedIRIS.get_group(2))
            print(name,groupedPIM.get_group(name).shape,groupedIRIS.get_group(name).shape)
    return      
main(bigmerged)            